{% extends 'layout.html.twig' %}

{% block title %} Forums {{ parent() }}{% endblock %}

{% block body %}

<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ path('/') }}"><i class="fa fa-home"></i></a></li>
    <li class="breadcrumb-item active">Forums</li>
</ol>
<div class="row">
    <div class="col-sm-9">
        {% if app.user %}
        <iframe style="width: 100%; height: 500px; color: transparent" class="mb-3" src="chatbox"></iframe>
        {% endif %}
        {% for categ in categories if categ.parent == null %}
            {% if categ.access.nom is not defined or is_granted(categ.access.role) %}
            <div class="no-padding content-section" id="custom-categ{{ categ.id }}">
                <div class="panel">

                    <div class="categTitle">
                        <div class="panel-title">
                            <span class="node-title"><i class="{{ categ.icon }}"></i> {{ categ.categorie }}</span>
                            <a data-toggle="collapse" href="#collapse{{ categ.id }}"></a>
                        </div>
                    </div>

                    <div id="collapse{{ categ.id }}" class="panel-collapse collapse show">
                        <div class="panel-body">
                            <table>
                                {% for sousCateg in categories if sousCateg.parent == categ.id %}
                                    {% if sousCateg.access.nom is not defined or is_granted(sousCateg.access.role) %}
                                        {% set nbCom = 0 %}
                                        {% for result in sousCateg.forumDiscussions.snapshot %}
                                            {% set nbCom = nbCom + result.forumCommentaires.count %}
                                        {% endfor %}
                                    <tr class="nodeLigne">
                                        <td class="nodeCol1">
                                            <i class="{{ sousCateg.icon }}"></i>
                                        </td>
                                        <td class="nodeCol2">
                                            <div class="nodeTitle">
                                                <a class="title-categ{{ categ.id }}" href="{{ path('forum.discussions', {id: sousCateg.id, slug: sousCateg.slug}) }}">
                                                    {{ sousCateg.categorie }}
                                                </a>
                                            </div>
                                            <div class="nodeStat">
                                                <div class="disparforumstat strongItem">
                                                    <span class="nodeStatItem">Discussions:</span> <span>{{ sousCateg.forumDiscussions.count }}</span>
                                                    <span class="nodeStatItem">Messages:</span> {{ sousCateg.forumDiscussions.count + nbCom }}<span></span>
                                                </div>
                                            </div>

                                        </td>
                                        <td class="nodeCol3">
                                            <div class="nodeLastPost">
                                                {% if sousCateg.forumDiscussions.count > 0 %}
                                                    {% for lastMessage in sousCateg.forumDiscussions.snapshot | slice(0, 1) %}
                                                        {% if lastMessage.forumCommentaires.count > 0 %}
                                                        {% set lastCom = max(lastMessage.forumCommentaires.snapshot) %}
                                                        <div class="noMessages">
                                                            <div class="node-extra-icon visitor-avatar">
                                                                <img height="36" width="36" src="{{ vich_uploader_asset( lastCom.auteur, 'imageFile') }}" alt="{{  lastCom.auteur.username }}" />
                                                            </div>
        													<div>
        									        			<span>Dernier: <a href="{{ path('forum.discussion', {id: lastMessage.id, slug: lastMessage.slug}) }}#ancreCom{{ lastCom.id }}">
                                                                    {{ lastMessage.titre | slice(0, 25) }}{% if lastMessage.titre|length > 25 %}...{% endif %}
                                                                </a></span>
        									        		</div>
        													<div>
        									        			<a class="pseudoUser{{ lastCom.auteur.role.id }}" href="{{ path('membres.profil', {id: lastCom.auteur.id, slug: lastCom.auteur.slug})}}">{{ lastCom.auteur.username }}</a>
                                                                , <span class="nodeStatItem"><i class="fa fa-clock-o"></i> {{ date_passed(lastCom.dateCreation | date('d-m-Y H:i:s')) }}</span>
        									        		</div>
        									        	</div>
                                                        {% else %}
                                                        <div class="noMessages">
                                                            <div class="node-extra-icon visitor-avatar">
                                                                <img height="36" width="36" src="{{ vich_uploader_asset( lastMessage.auteur, 'imageFile') }}" alt="{{  lastMessage.auteur.username }}" />
                                                            </div>
        													<div>
        									        			<span>Dernier: <a href="{{ path('forum.discussion', {id: lastMessage.id, slug: lastMessage.slug}) }}">
                                                                    {{ lastMessage.titre | slice(0, 20) }}{% if lastMessage.titre|length > 20 %}...{% endif %}
                                                                </a></span>
        									        		</div>
        													<div>
        									        			<a class="pseudoUser{{ lastMessage.auteur.role.id }}" href="{{ path('membres.profil', {id: lastMessage.auteur.id, slug: lastMessage.auteur.slug})}}">{{ lastMessage.auteur.username }}</a>
                                                                , <span class="nodeStatItem"><i class="fa fa-clock-o"></i> {{ date_passed(lastMessage.dateCreation | date('d-m-Y H:i:s')) }}</span>
        									        		</div>
        									        	</div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                <span class="noMessages nodeStatItem">(Ne contient aucun message)</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </table>
                        </div>
                    </div>

                </div>
            </div>
            <br/>
            {% endif %}
        {% endfor %}
    </div>
    <div class="col-sm-3">
        {{ include("inc/sidebar.html.twig") }}
    </div>
</div>
{% endblock %}
